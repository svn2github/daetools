<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>tutorial_che_3.py</title>
</head>
<!-- Highlighting: "Python" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<span style='color:#898887;'>#!/usr/bin/env python</span>
<span style='color:#898887;'># -*- coding: utf-8 -*-</span>

<span style='color:#898887;'>&quot;&quot;&quot;</span>
<span style='color:#898887;'>***********************************************************************************</span>
<span style='color:#898887;'>                           tutorial_che_3.py</span>
<span style='color:#898887;'>                DAE Tools: pyDAE module, www.daetools.com</span>
<span style='color:#898887;'>                Copyright (C) Dragan Nikolic</span>
<span style='color:#898887;'>***********************************************************************************</span>
<span style='color:#898887;'>DAE Tools is free software; you can redistribute it and/or modify it under the</span>
<span style='color:#898887;'>terms of the GNU General Public License version 3 as published by the Free Software</span>
<span style='color:#898887;'>Foundation. DAE Tools is distributed in the hope that it will be useful, but WITHOUT</span>
<span style='color:#898887;'>ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span style='color:#898887;'>PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>
<span style='color:#898887;'>You should have received a copy of the GNU General Public License along with the</span>
<span style='color:#898887;'>DAE Tools software; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span style='color:#898887;'>************************************************************************************</span>
<span style='color:#898887;'>&quot;&quot;&quot;</span>
__doc__ = <span style='color:#bf0303;'>&quot;&quot;&quot;</span>
<span style='color:#bf0303;'>Batch reactor seeded crystallisation using the method of moments.</span>

<span style='color:#bf0303;'>References (model equations and input parameters):</span>

<span style='color:#bf0303;'>- Nikolic D.D., Frawley P.J. (2016) Application of the Lagrangian Meshfree Approach</span>
<span style='color:#bf0303;'>  to Modelling of Batch Crystallisation: Part I – Modelling of Stirred Tank Hydrodynamics.</span>
<span style='color:#bf0303;'>  Chemical Engineering Science 145:317–328.</span>
<span style='color:#bf0303;'>  `doi:10.1016/j.ces.2015.08.052 &lt;http://dx.doi.org/10.1016/j.ces.2015.08.052&gt;`_</span>
<span style='color:#bf0303;'>- Mitchell N.A., O’Ciardha C.T., Frawley P.J. (2011) Estimation of the growth kinetics</span>
<span style='color:#bf0303;'>  for the cooling crystallisation of paracetamol and ethanol solutions.</span>
<span style='color:#bf0303;'>  Journal of Crystal Growth 328:39–49.</span>
<span style='color:#bf0303;'>  `doi:10.1016/j.jcrysgro.2011.06.016 &lt;http://dx.doi.org/10.1016/j.jcrysgro.2011.06.016&gt;`_</span>

<span style='color:#bf0303;'>The main assumptions:</span>

<span style='color:#bf0303;'>- Seeded crystallisation</span>
<span style='color:#bf0303;'>- Ideal mixing</span>
<span style='color:#bf0303;'>- Fixed cooling rate</span>
<span style='color:#bf0303;'>- Size independent growth</span>

<span style='color:#bf0303;'>Solubility of Paracetamol in ethanol:</span>

<span style='color:#bf0303;'>.. code-block:: none</span>

<span style='color:#bf0303;'>   ---------------------------------------------------------------------------------</span>
<span style='color:#bf0303;'>   Temperature, C   Solubility, kg Parac./kg EtOH    Solubility, mol Parac./m3 EtOH</span>
<span style='color:#bf0303;'>   ---------------------------------------------------------------------------------</span>
<span style='color:#bf0303;'>   0                0.11362                          593.0387</span>
<span style='color:#bf0303;'>   10               0.14128                          737.4215</span>
<span style='color:#bf0303;'>   20               0.17568                          916.9562</span>
<span style='color:#bf0303;'>   30               0.21845                          1140.2008</span>
<span style='color:#bf0303;'>   40               0.27163                          1417.7972</span>
<span style='color:#bf0303;'>   50               0.33777                          1762.9779</span>
<span style='color:#bf0303;'>   60               0.42000                          2192.1973</span>
<span style='color:#bf0303;'>   ---------------------------------------------------------------------------------</span>

<span style='color:#bf0303;'>The supersaturation plot:</span>

<span style='color:#bf0303;'>.. image:: _static/tutorial_che_3-results.png</span>
<span style='color:#bf0303;'>   :width: 500px</span>

<span style='color:#bf0303;'>The concentration plot:</span>

<span style='color:#bf0303;'>.. image:: _static/tutorial_che_3-results2.png</span>
<span style='color:#bf0303;'>   :width: 500px</span>

<span style='color:#bf0303;'>The recovery plot:</span>

<span style='color:#bf0303;'>.. image:: _static/tutorial_che_3-results3.png</span>
<span style='color:#bf0303;'>   :width: 500px</span>

<span style='color:#bf0303;'>The yield plot:</span>

<span style='color:#bf0303;'>.. image:: _static/tutorial_che_3-results4.png</span>
<span style='color:#bf0303;'>   :width: 500px</span>

<span style='color:#bf0303;'>The total number of crystals plot:</span>

<span style='color:#bf0303;'>.. image:: _static/tutorial_che_3-results5.png</span>
<span style='color:#bf0303;'>   :width: 500px</span>
<span style='color:#bf0303;'>&quot;&quot;&quot;</span>

<span style='color:#ff5500;'>import</span> sys, numpy
<span style='color:#ff5500;'>from</span> daetools.pyDAE <span style='color:#ff5500;'>import</span> *
<span style='color:#ff5500;'>from</span> time <span style='color:#ff5500;'>import</span> localtime, strftime

<span style='color:#898887;'># Standard variable types are defined in variable_types.py</span>
<span style='color:#ff5500;'>from</span> pyUnits <span style='color:#ff5500;'>import</span> m, g, kg, s, K, mol, kmol, J, um

pbm_growth_rate_t                = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_growth_rate_t&quot;</span>,                m/s,                    <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.1</span>, <span style='color:#b08000;'>1e-05</span>)
pbm_birth_rate_t                 = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_birth_rate_t&quot;</span>,                 (s**(-<span style='color:#b08000;'>1</span>)) * (m**(-<span style='color:#b08000;'>3</span>)),  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-05</span>)
pbm_death_rate_t                 = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_death_rate_t&quot;</span>,                 (s**(-<span style='color:#b08000;'>1</span>)) * (m**(-<span style='color:#b08000;'>3</span>)),  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-05</span>)
pbm_solution_concentration_t     = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_solution_concentration_t&quot;</span>,     kg/kg,                  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.1</span>, <span style='color:#b08000;'>1e-05</span>)
pbm_solution_concentration_vol_t = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_solution_concentration_vol_t&quot;</span>, kmol/(m**<span style='color:#b08000;'>3</span>),            <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.1</span>, <span style='color:#b08000;'>1e-05</span>)

pbm_number_t  = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_number_t&quot;</span>,  m**(-<span style='color:#b08000;'>3</span>),           <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-05</span>)
pbm_length_t  = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_length_t&quot;</span>,  m/(m**<span style='color:#b08000;'>3</span>),          <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-06</span>)
pbm_area_t    = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_area_t&quot;</span>,    (m**<span style='color:#b08000;'>2</span>)/(m**<span style='color:#b08000;'>3</span>),     <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-08</span>)
pbm_volume_t  = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_volume_t&quot;</span>,  (m**<span style='color:#b08000;'>3</span>)/(m**<span style='color:#b08000;'>3</span>),     <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-10</span>)
pbm_moment4_t = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_moment4_t&quot;</span>, (m**<span style='color:#b08000;'>4</span>)/(m**<span style='color:#b08000;'>3</span>),     <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-11</span>)
pbm_moment5_t = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_moment5_t&quot;</span>, (m**<span style='color:#b08000;'>5</span>)/(m**<span style='color:#b08000;'>3</span>),     <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-12</span>)

pbm_diameter_t = daeVariableType(<span style='color:#bf0303;'>&quot;pbm_diameter_t&quot;</span>,  m, <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1.0e+20</span>,  <span style='color:#b08000;'>0.0</span>, <span style='color:#b08000;'>1e-10</span>)

<b>class</b> modTutorial(daeModel):
    <b>def</b> <span style='color:#644a9b;'>__init__</span>(<span style='color:#0057ae;'>self</span>, Name, Parent = <span style='color:#0057ae;'>None</span>, Description = <span style='color:#bf0303;'>&quot;&quot;</span>):
        daeModel.<span style='color:#644a9b;'>__init__</span>(<span style='color:#0057ae;'>self</span>, Name, Parent, Description)

        <span style='color:#0057ae;'>self</span>.n = <span style='color:#b08000;'>2.276</span> <span style='color:#898887;'># Nucleation rate exponent</span>
        <span style='color:#0057ae;'>self</span>.g = <span style='color:#b08000;'>1.602</span> <span style='color:#898887;'># Growth rate exponent</span>
        kg_units = (m/s)*(((m**<span style='color:#b08000;'>3</span>)/kmol)**<span style='color:#b08000;'>1.602</span>)
        kn_units = (s**(-<span style='color:#b08000;'>1</span>))*(m**(-<span style='color:#b08000;'>3</span>)) * ((kg/kg)**<span style='color:#b08000;'>2.276</span>)

        <span style='color:#0057ae;'>self</span>.Nm = daeDomain(<span style='color:#bf0303;'>&quot;Nm&quot;</span>, <span style='color:#0057ae;'>self</span>, m, <span style='color:#bf0303;'>&quot;Number of moments&quot;</span>)
        
        <span style='color:#0057ae;'>self</span>.R      = daeParameter(<span style='color:#bf0303;'>&quot;R&quot;</span>,     J/(mol*K), <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Universal gas constant&quot;</span>)
        <span style='color:#0057ae;'>self</span>.MW     = daeParameter(<span style='color:#bf0303;'>&quot;MW&quot;</span>,    kg/kmol,   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Molecular weight of paracetamol&quot;</span>)
        <span style='color:#0057ae;'>self</span>.V      = daeParameter(<span style='color:#bf0303;'>&quot;V&quot;</span>,     m**<span style='color:#b08000;'>3</span>,      <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Volume of the suspension in the reactor&quot;</span>)
        <span style='color:#0057ae;'>self</span>.kg     = daeParameter(<span style='color:#bf0303;'>&quot;kg&quot;</span>,    kg_units,  <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Growth rate constant&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Ea     = daeParameter(<span style='color:#bf0303;'>&quot;Ea&quot;</span>,    J/mol,     <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Activation energy&quot;</span>)
        <span style='color:#0057ae;'>self</span>.kn     = daeParameter(<span style='color:#bf0303;'>&quot;kn&quot;</span>,    kn_units,  <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Nucleation rate constant&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Kv     = daeParameter(<span style='color:#bf0303;'>&quot;Kv&quot;</span>,    unit(),    <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Volume shape factor&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Ka     = daeParameter(<span style='color:#bf0303;'>&quot;Ka&quot;</span>,    unit(),    <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Surface area shape factor&quot;</span>)
        <span style='color:#0057ae;'>self</span>.rho_s  = daeParameter(<span style='color:#bf0303;'>&quot;rho_s&quot;</span>, kg/(m**<span style='color:#b08000;'>3</span>), <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Density of solution&quot;</span>)
        <span style='color:#0057ae;'>self</span>.cp_s   = daeParameter(<span style='color:#bf0303;'>&quot;cp_s&quot;</span>,  J/(kg*K),  <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Specific heat capacity of solution&quot;</span>)
        <span style='color:#0057ae;'>self</span>.rho_c  = daeParameter(<span style='color:#bf0303;'>&quot;rho_c&quot;</span>, kg/(m**<span style='color:#b08000;'>3</span>), <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Density of crystals&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Qr     = daeParameter(<span style='color:#bf0303;'>&quot;Qr&quot;</span>,    W,         <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Cooling rate&quot;</span>)
        <span style='color:#0057ae;'>self</span>.L0     = daeParameter(<span style='color:#bf0303;'>&quot;L_0&quot;</span>,   m,         <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Initial size of the nucleus&quot;</span>)

        <span style='color:#0057ae;'>self</span>.m0     = daeVariable(<span style='color:#bf0303;'>&quot;m_0&quot;</span>,    pbm_number_t,                       <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 0&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m1     = daeVariable(<span style='color:#bf0303;'>&quot;m_1&quot;</span>,    pbm_length_t,                       <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 1&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m2     = daeVariable(<span style='color:#bf0303;'>&quot;m_2&quot;</span>,    pbm_area_t,                         <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 2&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m3     = daeVariable(<span style='color:#bf0303;'>&quot;m_3&quot;</span>,    pbm_volume_t,                       <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 3&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m4     = daeVariable(<span style='color:#bf0303;'>&quot;m_4&quot;</span>,    pbm_moment4_t,                      <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 4&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m5     = daeVariable(<span style='color:#bf0303;'>&quot;m_5&quot;</span>,    pbm_moment5_t,                      <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Distribution moment 5&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m_norm = daeVariable(<span style='color:#bf0303;'>&quot;m_norm&quot;</span>, no_t,                               <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Normalized distribution moments&quot;</span>, [<span style='color:#0057ae;'>self</span>.Nm])
        <span style='color:#0057ae;'>self</span>.T      = daeVariable(<span style='color:#bf0303;'>&quot;T&quot;</span>,      temperature_t,                      <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Solution temperature&quot;</span>)
        <span style='color:#0057ae;'>self</span>.G      = daeVariable(<span style='color:#bf0303;'>&quot;G&quot;</span>,      pbm_growth_rate_t,                  <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Growth rate&quot;</span>)
        <span style='color:#0057ae;'>self</span>.B      = daeVariable(<span style='color:#bf0303;'>&quot;B&quot;</span>,      pbm_birth_rate_t,                   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Birth rate&quot;</span>)
        <span style='color:#0057ae;'>self</span>.c      = daeVariable(<span style='color:#bf0303;'>&quot;c&quot;</span>,      pbm_solution_concentration_t,       <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Solution concentration&quot;</span>)
        <span style='color:#0057ae;'>self</span>.c_star = daeVariable(<span style='color:#bf0303;'>&quot;c_star&quot;</span>, pbm_solution_concentration_t,       <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Solution equlibrium concentration (solubility)&quot;</span>)
        <span style='color:#0057ae;'>self</span>.delta_c= daeVariable(<span style='color:#bf0303;'>&quot;delta_c&quot;</span>,pbm_solution_concentration_vol_t,   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Concentrations driving force&quot;</span>)
        <span style='color:#0057ae;'>self</span>.S      = daeVariable(<span style='color:#bf0303;'>&quot;S&quot;</span>,      no_t,                               <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Supersaturation&quot;</span>)
        
        <span style='color:#0057ae;'>self</span>.Yield      = daeVariable(<span style='color:#bf0303;'>&quot;Yield&quot;</span>,      mass_t,         <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Crystals yield&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Yield_max  = daeVariable(<span style='color:#bf0303;'>&quot;Yield_max&quot;</span>,  mass_t,         <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Maximal crystals yield&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Recovery   = daeVariable(<span style='color:#bf0303;'>&quot;Recovery&quot;</span>,   no_t,           <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Product recovery&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Ntotal     = daeVariable(<span style='color:#bf0303;'>&quot;Ntotal&quot;</span>,     pbm_number_t,   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Total number of crystals&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Ltotal     = daeVariable(<span style='color:#bf0303;'>&quot;Ltotal&quot;</span>,     pbm_length_t,   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Total length of crystals&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Atotal     = daeVariable(<span style='color:#bf0303;'>&quot;Atotal&quot;</span>,     pbm_area_t,     <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Total surface area of crystals&quot;</span>)
        <span style='color:#0057ae;'>self</span>.Vtotal     = daeVariable(<span style='color:#bf0303;'>&quot;Vtotal&quot;</span>,     pbm_volume_t,   <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Total volume of crystals&quot;</span>)
        <span style='color:#0057ae;'>self</span>.D10        = daeVariable(<span style='color:#bf0303;'>&quot;D10&quot;</span>,        pbm_diameter_t, <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Mean size of crystals 1&quot;</span>)
        <span style='color:#0057ae;'>self</span>.D43        = daeVariable(<span style='color:#bf0303;'>&quot;D43&quot;</span>,        pbm_diameter_t, <span style='color:#0057ae;'>self</span>, <span style='color:#bf0303;'>&quot;Mean size of crystals 2&quot;</span>)

    <b>def</b> DeclareEquations(<span style='color:#0057ae;'>self</span>):
        daeModel.DeclareEquations(<span style='color:#0057ae;'>self</span>)

        <span style='color:#898887;'># Heat balance</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;T&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.rho_s() * <span style='color:#0057ae;'>self</span>.V() * <span style='color:#0057ae;'>self</span>.cp_s() * <span style='color:#0057ae;'>self</span>.T.dt() - <span style='color:#0057ae;'>self</span>.Qr() * (<span style='color:#0057ae;'>self</span>.T() - Constant(<span style='color:#b08000;'>273.14</span> * K))/Constant(<span style='color:#b08000;'>1</span> * K)

        <span style='color:#898887;'># Solution concentration</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;c&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.c.dt() + <span style='color:#b08000;'>3</span> * <span style='color:#0057ae;'>self</span>.rho_c() * <span style='color:#0057ae;'>self</span>.Kv() * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m2() / <span style='color:#0057ae;'>self</span>.rho_s()

        <span style='color:#898887;'># Solubility (in kg/kg, as given in the paper)</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;c_star&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.c_star() - <span style='color:#b08000;'>2.955e-4</span> * Exp(Constant(<span style='color:#b08000;'>2.179e-2</span> * <span style='color:#b08000;'>1</span>/K) * <span style='color:#0057ae;'>self</span>.T())

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;S&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.S() - <span style='color:#0057ae;'>self</span>.c() / (<span style='color:#0057ae;'>self</span>.c_star() + Constant(<span style='color:#b08000;'>1e-20</span> * kg/kg))

        <span style='color:#898887;'># Nucleation kinetics</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;B&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.B() - <span style='color:#0057ae;'>self</span>.kn() * (<span style='color:#0057ae;'>self</span>.delta_c()**<span style='color:#0057ae;'>self</span>.n)
        eq.CheckUnitsConsistency = <span style='color:#0057ae;'>False</span>

        <span style='color:#898887;'># Nucleation kinetics</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;delta_c&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.delta_c() - (<span style='color:#0057ae;'>self</span>.c() - <span style='color:#0057ae;'>self</span>.c_star()) * <span style='color:#0057ae;'>self</span>.rho_s() / <span style='color:#0057ae;'>self</span>.MW()
        
        <span style='color:#898887;'># Growth kinetics</span>
        <span style='color:#898887;'># A safe-guard: prevent the negative concentration by setting the growth rate to zero</span>
        <span style='color:#898887;'># if the supersaturation drops below one (that is no driving force)</span>
        <span style='color:#0057ae;'>self</span>.IF(<span style='color:#0057ae;'>self</span>.S() &gt; <span style='color:#b08000;'>1</span>)
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;G&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.G() - <span style='color:#0057ae;'>self</span>.kg() * Exp(-<span style='color:#0057ae;'>self</span>.Ea() / (<span style='color:#0057ae;'>self</span>.R() * <span style='color:#0057ae;'>self</span>.T())) * (<span style='color:#0057ae;'>self</span>.delta_c()**<span style='color:#0057ae;'>self</span>.g)
        eq.CheckUnitsConsistency = <span style='color:#0057ae;'>False</span>

        <span style='color:#0057ae;'>self</span>.ELSE()
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;G&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.G()
        <span style='color:#0057ae;'>self</span>.END_IF()
        
        <span style='color:#898887;'># Moments</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(0)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m0.dt() - <span style='color:#0057ae;'>self</span>.B()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(1)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m1.dt() - <span style='color:#b08000;'>1</span> * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m0() - <span style='color:#0057ae;'>self</span>.B() * (<span style='color:#0057ae;'>self</span>.L0()**<span style='color:#b08000;'>1</span>)

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(2)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m2.dt() - <span style='color:#b08000;'>2</span> * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m1() - <span style='color:#0057ae;'>self</span>.B() * (<span style='color:#0057ae;'>self</span>.L0()**<span style='color:#b08000;'>2</span>)
        eq.Scaling = <span style='color:#b08000;'>1e5</span>

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(3)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m3.dt() - <span style='color:#b08000;'>3</span> * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m2() - <span style='color:#0057ae;'>self</span>.B() * (<span style='color:#0057ae;'>self</span>.L0()**<span style='color:#b08000;'>3</span>)
        eq.Scaling = <span style='color:#b08000;'>1e8</span>

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(4)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m4.dt() - <span style='color:#b08000;'>4</span> * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m3() - <span style='color:#0057ae;'>self</span>.B() * (<span style='color:#0057ae;'>self</span>.L0()**<span style='color:#b08000;'>4</span>)
        eq.Scaling = <span style='color:#b08000;'>1e10</span>

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Moment(5)&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.m5.dt() - <span style='color:#b08000;'>5</span> * <span style='color:#0057ae;'>self</span>.G() * <span style='color:#0057ae;'>self</span>.m4() - <span style='color:#0057ae;'>self</span>.B() * (<span style='color:#0057ae;'>self</span>.L0()**<span style='color:#b08000;'>5</span>)
        eq.Scaling = <span style='color:#b08000;'>1e12</span>

        <span style='color:#898887;'># Normalized moments 0-5</span>
        moments = [<span style='color:#0057ae;'>self</span>.m0(), <span style='color:#0057ae;'>self</span>.m1(), <span style='color:#0057ae;'>self</span>.m2(), <span style='color:#0057ae;'>self</span>.m3(), <span style='color:#0057ae;'>self</span>.m4(), <span style='color:#0057ae;'>self</span>.m5()]
        <b>for</b> k <b>in</b> <b><span style='color:#644a9b;'>range</span></b>(<span style='color:#b08000;'>0</span>, <span style='color:#0057ae;'>self</span>.Nm.NumberOfPoints):
            eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;NormalizedMoment(</span><span style='color:#3daee9;'>%d</span><span style='color:#bf0303;'>)&quot;</span> % k, <span style='color:#bf0303;'>&quot;&quot;</span>)
            eq.Residual = <span style='color:#0057ae;'>self</span>.m_norm(k) * <span style='color:#0057ae;'>self</span>.m0() - moments[k]
            eq.CheckUnitsConsistency = <span style='color:#0057ae;'>False</span>

        <span style='color:#898887;'># Performance indicators</span>
        <span style='color:#898887;'># Crystals concentration (crystals yield)</span>
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Yield&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Yield() - <span style='color:#0057ae;'>self</span>.rho_c() * <span style='color:#0057ae;'>self</span>.Kv() * <span style='color:#0057ae;'>self</span>.m3() * <span style='color:#0057ae;'>self</span>.V()
            
        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Yield_max&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Yield_max() - <span style='color:#0057ae;'>self</span>.rho_c() * <span style='color:#0057ae;'>self</span>.Kv() * <span style='color:#0057ae;'>self</span>.m3() * <span style='color:#0057ae;'>self</span>.V() - <span style='color:#0057ae;'>self</span>.c()*<span style='color:#0057ae;'>self</span>.rho_s()*<span style='color:#0057ae;'>self</span>.V()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Recovery&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Recovery() - <span style='color:#0057ae;'>self</span>.Yield() / (<span style='color:#0057ae;'>self</span>.Yield_max() + Constant(<span style='color:#b08000;'>1E-20</span>*kg))

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Ntotal&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Ntotal() - <span style='color:#0057ae;'>self</span>.m0()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Ltotal&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Ltotal() - <span style='color:#0057ae;'>self</span>.m1()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Atotal&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Atotal() - <span style='color:#0057ae;'>self</span>.Ka() * <span style='color:#0057ae;'>self</span>.m2()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;Vtotal&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.Vtotal() - <span style='color:#0057ae;'>self</span>.Kv() * <span style='color:#0057ae;'>self</span>.m3()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;D10&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.D10() * <span style='color:#0057ae;'>self</span>.m0() - <span style='color:#0057ae;'>self</span>.m1()

        eq = <span style='color:#0057ae;'>self</span>.CreateEquation(<span style='color:#bf0303;'>&quot;D43&quot;</span>, <span style='color:#bf0303;'>&quot;&quot;</span>)
        eq.Residual = <span style='color:#0057ae;'>self</span>.D43() * <span style='color:#0057ae;'>self</span>.m3() - <span style='color:#0057ae;'>self</span>.m4()

<b>class</b> simTutorial(daeSimulation):
    <b>def</b> <span style='color:#644a9b;'>__init__</span>(<span style='color:#0057ae;'>self</span>):
        daeSimulation.<span style='color:#644a9b;'>__init__</span>(<span style='color:#0057ae;'>self</span>)
        <span style='color:#0057ae;'>self</span>.m = modTutorial(<span style='color:#bf0303;'>&quot;tutorial_che_3&quot;</span>)
        <span style='color:#0057ae;'>self</span>.m.Description = __doc__

    <b>def</b> SetUpParametersAndDomains(<span style='color:#0057ae;'>self</span>):
        <span style='color:#0057ae;'>self</span>.m.Nm.CreateArray(<span style='color:#b08000;'>6</span>)

        <span style='color:#0057ae;'>self</span>.m.V.SetValue(<span style='color:#b08000;'>0.5e-3</span> * m**<span style='color:#b08000;'>3</span>)
        
        <span style='color:#0057ae;'>self</span>.m.R.SetValue(<span style='color:#b08000;'>8.3144</span> * J/(mol*K))
        <span style='color:#0057ae;'>self</span>.m.MW.SetValue(<span style='color:#b08000;'>151.163</span> * g/mol)
        
        <span style='color:#0057ae;'>self</span>.m.kg.SetValue(<span style='color:#b08000;'>9.979</span>)
        <span style='color:#0057ae;'>self</span>.m.Ea.SetValue(<span style='color:#b08000;'>40560</span> * J/mol)

        <span style='color:#0057ae;'>self</span>.m.kn.SetValue(<span style='color:#b08000;'>1.597E10</span>/<span style='color:#b08000;'>60.0</span> * ((s**(-<span style='color:#b08000;'>1</span>))*(m**(-<span style='color:#b08000;'>3</span>))))

        <span style='color:#0057ae;'>self</span>.m.Ka.SetValue(<span style='color:#b08000;'>5.196</span>)               <span style='color:#898887;'># Surface area shape factor</span>
        <span style='color:#0057ae;'>self</span>.m.Kv.SetValue(<span style='color:#b08000;'>0.866</span>)               <span style='color:#898887;'># Volume shape factor</span>
        <span style='color:#0057ae;'>self</span>.m.rho_c.SetValue(<span style='color:#b08000;'>1332</span> * kg/(m**<span style='color:#b08000;'>3</span>)) <span style='color:#898887;'># Paracetamol</span>
        <span style='color:#0057ae;'>self</span>.m.rho_s.SetValue(<span style='color:#b08000;'>789</span> * kg/(m**<span style='color:#b08000;'>3</span>))  <span style='color:#898887;'># Ethanol</span>
        <span style='color:#0057ae;'>self</span>.m.cp_s.SetValue(<span style='color:#b08000;'>112.4</span> * J/(kg*K))  <span style='color:#898887;'># cp of Ethanol</span>
        <span style='color:#0057ae;'>self</span>.m.Qr.SetValue(<span style='color:#b08000;'>0.0</span> * W)             <span style='color:#898887;'># Cooling rate in Watts</span>
        <span style='color:#0057ae;'>self</span>.m.L0.SetValue(<span style='color:#b08000;'>1e-6</span> * m)            <span style='color:#898887;'># 1um</span>

    <b>def</b> SetUpVariables(<span style='color:#0057ae;'>self</span>):
        <span style='color:#898887;'># Initial conditions</span>
        <span style='color:#0057ae;'>self</span>.m.T.SetInitialCondition(<span style='color:#b08000;'>293.15</span> * K)
        <span style='color:#0057ae;'>self</span>.m.c.SetInitialCondition(<span style='color:#b08000;'>0.275395968</span> * kg/kg)
        
        <span style='color:#898887;'># Actung, Achtung!!</span>
        <span style='color:#898887;'># Initial moments for 1.0081g of 125-250um seed (as in Niall's paper)</span>
        <span style='color:#898887;'># The meaning of the above: the values are given in m**k per gram of paracetamol,</span>
        <span style='color:#898887;'># and need to be transformed into the values in m**k/m**3</span>
        m_seed = numpy.array([<span style='color:#b08000;'>514967.2105</span> * (m**<span style='color:#b08000;'>0</span>)/g,
                              <span style='color:#b08000;'>42.56573654</span> * (m**<span style='color:#b08000;'>1</span>)/g,
                              <span style='color:#b08000;'>0.005234078</span> * (m**<span style='color:#b08000;'>2</span>)/g,
                              <span style='color:#b08000;'>8.84516e-07</span> * (m**<span style='color:#b08000;'>3</span>)/g,
                              <span style='color:#b08000;'>1.90332e-10</span> * (m**<span style='color:#b08000;'>4</span>)/g,
                              <span style='color:#b08000;'>5.00159e-14</span> * (m**<span style='color:#b08000;'>5</span>)/g])
        moments = [<span style='color:#0057ae;'>self</span>.m.m0, <span style='color:#0057ae;'>self</span>.m.m1, <span style='color:#0057ae;'>self</span>.m.m2, <span style='color:#0057ae;'>self</span>.m.m3, <span style='color:#0057ae;'>self</span>.m.m4, <span style='color:#0057ae;'>self</span>.m.m5]
        <span style='color:#898887;'># a) Change to moments per kg of ethanol: m_seed /= rho_EtOH*V</span>
        <span style='color:#898887;'>#    (in the Niall's paper moments are given in m**k/kg, therefore: m_seed /= 0.394 * g/kg)</span>
        <span style='color:#898887;'># b) Change to moments per m3 of ethanol: m_seed *= V (we use moments standardly given in m**k/m**3)</span>
        <span style='color:#898887;'># Also, the above numbers are given per one gram of seed - multiply the moments by actual weight of seed in grams</span>
        m_seed *= (<span style='color:#b08000;'>7.0109</span>*g) / <span style='color:#0057ae;'>self</span>.m.V.GetQuantity()
        <span style='color:#898887;'>#print m_seed</span>
        <b>for</b> k <b>in</b> <b><span style='color:#644a9b;'>range</span></b>(<span style='color:#b08000;'>0</span>, <span style='color:#0057ae;'>self</span>.m.Nm.NumberOfPoints):
            moments[k].SetInitialCondition(m_seed[k])

<span style='color:#898887;'># Use daeSimulator class</span>
<b>def</b> guiRun(app):
    sim = simTutorial()
    sim.m.SetReportingOn(<span style='color:#0057ae;'>True</span>)
    sim.ReportingInterval = <span style='color:#b08000;'>60</span>
    sim.TimeHorizon       = <span style='color:#b08000;'>3000</span>
    simulator  = daeSimulator(app, simulation=sim)
    simulator.exec_()

<span style='color:#898887;'># Setup everything manually and run in a console</span>
<b>def</b> consoleRun():
    <span style='color:#898887;'># Create Log, Solver, DataReporter and Simulation object</span>
    log          = daePythonStdOutLog()
    daesolver    = daeIDAS()
    datareporter = daeTCPIPDataReporter()
    simulation   = simTutorial()

    <span style='color:#898887;'># Relative tolerance</span>
    daesolver.RelativeTolerance = <span style='color:#b08000;'>1e-07</span>
    
    <span style='color:#898887;'># Enable reporting of all variables</span>
    simulation.m.SetReportingOn(<span style='color:#0057ae;'>True</span>)

    <span style='color:#898887;'># Set the time horizon and the reporting interval</span>
    simulation.ReportingInterval = <span style='color:#b08000;'>60</span>
    simulation.TimeHorizon       = <span style='color:#b08000;'>3000</span>

    <span style='color:#898887;'># Connect data reporter</span>
    simName = simulation.m.Name + strftime(<span style='color:#bf0303;'>&quot; [</span><span style='color:#3daee9;'>%d</span><span style='color:#bf0303;'>.%m.%Y %H:%M:%S]&quot;</span>, localtime())
    <b>if</b>(datareporter.Connect(<span style='color:#bf0303;'>&quot;&quot;</span>, simName) == <span style='color:#0057ae;'>False</span>):
        sys.exit()

    <span style='color:#898887;'># Initialize the simulation</span>
    simulation.Initialize(daesolver, datareporter, log)

    <span style='color:#898887;'># Save the model report and the runtime model report</span>
    simulation.m.SaveModelReport(simulation.m.Name + <span style='color:#bf0303;'>&quot;.xml&quot;</span>)
    simulation.m.SaveRuntimeModelReport(simulation.m.Name + <span style='color:#bf0303;'>&quot;-rt.xml&quot;</span>)

    <span style='color:#898887;'># Solve at time=0 (initialization)</span>
    simulation.SolveInitial()

    <span style='color:#898887;'># Run</span>
    simulation.Run()
    simulation.Finalize()

<b>if</b> <span style='color:#0057ae;'>__name__</span> == <span style='color:#bf0303;'>&quot;__main__&quot;</span>:
    <b>if</b> <b><span style='color:#644a9b;'>len</span></b>(sys.argv) &gt; <span style='color:#b08000;'>1</span> <b>and</b> (sys.argv[<span style='color:#b08000;'>1</span>] == <span style='color:#bf0303;'>'console'</span>):
        consoleRun()
    <b>else</b>:
        app = daeCreateQtApplication(sys.argv)
        guiRun(app)
</pre>
</body>
</html>
